#######################
# INITIAL SETUP TASKS #
#######################

- name: Set hostname
  become: true
  ansible.builtin.hostname:
    name: '{{ inventory_hostname }}'

- name: Set locale
  become: true
  community.general.locale_gen:
    name: en_US.UTF-8

- name: Disable SSH host hashing
  become: true
  ansible.builtin.lineinfile:
    path: /etc/ssh/ssh_config
    search_string: "HashKnownHosts yes"
    line: "HashKnownHosts no"

- name: Add GitHub fingerprint to known_hosts
  ansible.builtin.known_hosts:
    name: github.com
    key: github.com ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBEmKSENjQEezOmxkZMy7opKgwFB9nkt5YRrYMjNuG5N87uRgg6CLrbo5wAdT/y6v0mKV0U2w0WZ2YB/++Tpockg=

- name: Add Bitbucket fingerprint to known_hosts
  ansible.builtin.known_hosts:
    name: bitbucket.org
    key: bitbucket.org ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBPIQmuzMBuKdWeF4+a2sjSSpBK0iqitSQ+5BM9KhpexuGt20JpTVM7u5BDZngncgrqDMbWdxMWWOGtZ9UgbqgZE=

- name: Configure git
  ansible.builtin.blockinfile:
    path: "{{ ansible_env.HOME }}/.gitconfig"
    create: true
    insertbefore: BOF
    block: |
      [user]
          name = VirtualWolf
          email = virtualwolf@virtualwolf.org


#####################################
# UPDATE APT CACHES, UPGRADE SYSTEM #
#####################################

- name: Update and upgrade apt packages
  ansible.builtin.include_role:
    name: upgrade_packages

- name: Install packages
  become: true
  ansible.builtin.apt:
    pkg:
      - vim
      - git
      - tmux


###########################
# CREATE SOURCE DIRECTORY #
###########################

- name: "Create {{ source_dir }}"
  become: true
  ansible.builtin.file:
    path: "{{ source_dir }}"
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"


#################
# SET UP CONFIG #
#################

- name: Clone config repository
  ansible.builtin.include_role:
    name: update_config_repository_and_bashmarks


###############################
# STANDARD USER PROFILE SETUP #
###############################

- name: "Remove existing {{ ansible_env.HOME }}/.bashrc"
  ansible.builtin.file:
    path: "{{ ansible_env.HOME }}/.bashrc"
    state: absent

- name: "Get stats of {{ ansible_env.HOME }}/.profile"
  become: true
  ansible.builtin.stat:
    path: "{{ ansible_env.HOME }}/.profile"
  register: user_profile

- name: "Remove existing {{ ansible_env.HOME }}/.profile if it's not a symlink"
  ansible.builtin.file:
    path: "{{ ansible_env.HOME }}/.profile"
    state: absent
  when: user_profile.stat.islnk is defined and user_profile.stat.islnk == False

- name: "Add symlink from config repository as {{ ansible_env.HOME }}/.profile"
  ansible.builtin.file:
    src: "{{ source_dir }}/config/profile_init"
    dest: "{{ ansible_env.HOME }}/.profile"
    state: link


###########################
# ROOT USER PROFILE SETUP #
###########################

- name: Remove existing /root/.profile
  become: true
  ansible.builtin.file:
    path: "/root/.profile"
    state: absent

- name: "Get stats of /root/.bashrc"
  become: true
  ansible.builtin.stat:
    path: /root/.bashrc
  register: root_bashrc

- name: Remove existing ~/.bashrc for root user if it's not a symlink
  become: true
  ansible.builtin.file:
    path: "/root/.bashrc"
    state: absent
  when: root_bashrc.stat.islnk is defined and root_bashrc.stat.islnk == False

- name: Add symlink from config repository for root user
  become: true
  ansible.builtin.file:
    src: "{{ source_dir }}/config/profile_init"
    dest: "/root/.bashrc"
    state: link

- name: Add symlink for bashmarks to root user
  become: true
  ansible.builtin.file:
    src: "{{ ansible_env.HOME }}/.sdirs"
    dest: /root/.sdirs
    state: link
